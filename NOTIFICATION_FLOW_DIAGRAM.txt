╔═══════════════════════════════════════════════════════════════════════════╗
║                    NOTIFICATION SYSTEM - FLOW DIAGRAM                      ║
╚═══════════════════════════════════════════════════════════════════════════╝

═══════════════════════════════════════════════════════════════════════════
                        📱 STUDENT BORROW FLOW
═══════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────┐
│ 1. STUDENT SUBMITS BORROW REQUEST                                       │
└─────────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │  BorrowService.dart     │
                    │  borrowBook()           │
                    └─────────────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │  Firestore              │
                    │  borrow_requests/       │
                    │  status: "pending"      │
                    └─────────────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │  NotificationService    │
                    │  sendNotification()     │
                    └─────────────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │  🔔 NOTIFICATION        │
                    │  "Request Submitted"    │
                    └─────────────────────────┘

═══════════════════════════════════════════════════════════════════════════
                        👨‍💼 ADMIN APPROVAL FLOW
═══════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────┐
│ 2. ADMIN REVIEWS & APPROVES REQUEST                                     │
└─────────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │  ManageRequestPage      │
                    │  _updateStatus()        │
                    └─────────────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │  Firestore              │
                    │  status: "accepted"     │
                    │  book available: false  │
                    └─────────────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │  NotificationService    │
                    │  sendBorrowApproved     │
                    │  Notification()         │
                    └─────────────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │  ✅ NOTIFICATION        │
                    │  "Request Approved"     │
                    │  Due: 25/10/2025        │
                    └─────────────────────────┘

═══════════════════════════════════════════════════════════════════════════
                        🕐 AUTOMATED REMINDER FLOW
═══════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────┐
│ 3. AUTOMATED DUE DATE REMINDER (3 DAYS BEFORE)                          │
└─────────────────────────────────────────────────────────────────────────┘
                                  │
                    ⏰ Every Hour (Timer)
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │  NotificationScheduler  │
                    │  _checkNotifications()  │
                    └─────────────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │  NotificationService    │
                    │  checkAndSendDueDate    │
                    │  Reminders()            │
                    └─────────────────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │                           │
                    ▼                           ▼
        ┌──────────────────┐      ┌──────────────────┐
        │ Query Firestore  │      │ For each book:   │
        │ status=accepted  │      │ - Check due date │
        │                  │      │ - Check reminder │
        └──────────────────┘      │   not sent       │
                                  └──────────────────┘
                                            │
                                            ▼
                            ┌────────────────────────┐
                            │ Due in 3 days?         │
                            │ AND reminderSent=false │
                            └────────────────────────┘
                                            │
                            ┌───────────────┴───────────────┐
                            │ YES                    NO     │
                            ▼                               ▼
                ┌─────────────────────┐         ┌────────────────┐
                │ Send Reminder       │         │ Skip           │
                │ Update reminderSent │         └────────────────┘
                │ to true             │
                └─────────────────────┘
                            │
                            ▼
                ┌─────────────────────┐
                │ 🕐 NOTIFICATION     │
                │ "Due Date Reminder" │
                │ Book due 22/10/2025 │
                └─────────────────────┘

═══════════════════════════════════════════════════════════════════════════
                        ⚠️ OVERDUE ALERT FLOW
═══════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────┐
│ 4. AUTOMATED OVERDUE NOTIFICATION (DAILY)                               │
└─────────────────────────────────────────────────────────────────────────┘
                                  │
                    ⏰ Every Hour (Timer)
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │  NotificationScheduler  │
                    │  _checkNotifications()  │
                    └─────────────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │  NotificationService    │
                    │  checkAndSendOverdue    │
                    │  Notifications()        │
                    └─────────────────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │                           │
                    ▼                           ▼
        ┌──────────────────┐      ┌──────────────────┐
        │ Query Firestore  │      │ For each book:   │
        │ status=accepted  │      │ - Check due date │
        └──────────────────┘      │ - Check last     │
                                  │   notification   │
                                  └──────────────────┘
                                            │
                                            ▼
                            ┌────────────────────────┐
                            │ Overdue?               │
                            │ AND >24hrs since last? │
                            └────────────────────────┘
                                            │
                            ┌───────────────┴───────────────┐
                            │ YES                    NO     │
                            ▼                               ▼
                ┌─────────────────────┐         ┌────────────────┐
                │ Calculate days      │         │ Skip           │
                │ overdue             │         └────────────────┘
                │ Send notification   │
                │ Update timestamp    │
                └─────────────────────┘
                            │
                            ▼
                ┌─────────────────────┐
                │ ⚠️  NOTIFICATION    │
                │ "Overdue Book"      │
                │ 3 days overdue      │
                └─────────────────────┘

═══════════════════════════════════════════════════════════════════════════
                        🔄 BOOK RENEWAL FLOW
═══════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────┐
│ 5. STUDENT RENEWS BOOK                                                   │
└─────────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │  BorrowHistoryPage      │
                    │  Renew Button Clicked   │
                    └─────────────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │  Firestore Update       │
                    │  dueDate: +14 days      │
                    │  reminderSent: false    │
                    └─────────────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │  NotificationService    │
                    │  sendBookRenewed        │
                    │  Notification()         │
                    └─────────────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │  🔄 NOTIFICATION        │
                    │  "Book Renewed"         │
                    │  New due: 05/11/2025    │
                    └─────────────────────────┘

═══════════════════════════════════════════════════════════════════════════
                        📱 NOTIFICATION UI FLOW
═══════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────┐
│ 6. STUDENT VIEWS NOTIFICATIONS                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │                           │
                    ▼                           ▼
        ┌──────────────────┐      ┌──────────────────┐
        │ HomePage         │      │ NotificationsPage│
        │ Bottom Nav       │      │ Full List        │
        │                  │      │                  │
        │  🔔 + Badge      │      │  All Notifs      │
        │  Shows count     │      │  Color-coded     │
        │  (e.g., "5")     │      │  Tap to read     │
        └──────────────────┘      └──────────────────┘
                    │                           │
                    └─────────────┬─────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │  StreamBuilder          │
                    │  Real-time updates      │
                    │  users/{uid}/           │
                    │  notifications/         │
                    └─────────────────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │                           │
                    ▼                           ▼
        ┌──────────────────┐      ┌──────────────────┐
        │ Tap Notification │      │ Mark All Read    │
        │ markAsRead()     │      │ markAllAsRead()  │
        └──────────────────┘      └──────────────────┘
                    │                           │
                    └─────────────┬─────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │  Update Firestore       │
                    │  read: true             │
                    └─────────────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │  Badge Updates          │
                    │  Count Decreases        │
                    └─────────────────────────┘

═══════════════════════════════════════════════════════════════════════════
                        🎨 NOTIFICATION TYPES & ICONS
═══════════════════════════════════════════════════════════════════════════

    📚 BORROW (Green)         - Request submitted
    ✅ APPROVED (Blue)        - Admin approved request
    ❌ REJECTED (Purple)      - Admin rejected request
    🕐 REMINDER (Orange)      - 3 days before due
    ⚠️  OVERDUE (Red)         - Book is overdue
    🔄 RENEWED (Cyan)         - Book renewal confirmed
    🔔 GENERAL (Brown)        - General notifications

═══════════════════════════════════════════════════════════════════════════
                        ⚙️ KEY FIRESTORE FIELDS
═══════════════════════════════════════════════════════════════════════════

borrow_requests/{requestId}
├── status: "pending" | "accepted" | "rejected" | "returned"
├── dueDate: Timestamp
├── reminderSent: boolean          ← Prevents duplicate reminders
├── lastOverdueNotification: Timestamp ← Prevents spam
└── rejectionReason: string (optional)

users/{userId}/notifications/{notificationId}
├── title: string
├── message: string
├── type: string                   ← Determines icon/color
├── timestamp: Timestamp
├── read: boolean                  ← Controls badge count
└── dueDate: Timestamp (optional)

═══════════════════════════════════════════════════════════════════════════

                        ✨ SYSTEM IS READY TO USE! ✨

═══════════════════════════════════════════════════════════════════════════
